<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-selector/core-selector.html">
<link rel="import" href="../core-input/core-input.html">
<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">
<link rel="import" href="../google-apis/google-maps-api.html">
<!-- <link rel="import" href="../th-geocoder-firebase/th-geocoder-firebase.html"> -->

<!--

The th-geocoder retrieves the latitude and longitude coordinates of a location or set of locations. It also can retrieve the location name, given a set or multple sets of coordinates.

##### Example

    <th-geocoder></th-geocoder>

@element th-geocoder
@blurb The th-geocoder retrieves the latitude and longitude coordinates of a location or set of locations. It also can retrieve the location name, given a set or multple sets of coordinates.
@status alpha
@homepage http://thelmanews.github.io/th-geocoder
-->
<polymer-element name="th-geocoder" attributes="input reverseGeocode output">

  <template>
    <style>
      core-selector {
        min-height: 10px;
        display: inline-block;
      }

      core-selector .col {
        padding: 3px;
        border: 1px solid #ccc;
      }
      core-selector .core-selected {
        background-color: #ccc;
        border: 1px solid #888;
      }

      label {
        display: block;
        color: #2fa3af;
        border-top: 1px solid #AAA;
      }

      .elTitle {
        color: #2fa3af;
        padding: 2px;
      }
    </style>
    <!-- Load Google Maps API -->
    <google-maps-api on-api-load="{{apiReady}}"></google-maps-api>
    
    <!-- Menu for selecting input --> 
    <core-icon-button icon="perm-data-setting" on-click="{{showControls}}"></core-icon-button>
    <core-collapse id="ctrl_collapse">      
      <label for="label_selector">Select label column: </label> 
      <core-selector id="label_selector" selected="{{_selectedLabel}}" valueattr="label">
        <template repeat="{{attr in _dataAttributes}}">
          <div label="{{attr}}">{{attr}}</div>
        </template>
      </core-selector>
    </core-collapse>


    <template repeat="{{place in output}}">
      <li>{{place.label}}: ({{place.latitude}}, {{place.longitude}})</li>
    </template>
  </template>

  <script>

    Polymer({
      // input: 'New York, NY', // string
      // input: ['1501 Lexington Avenue, New York, NY 10029', '54 West 40th Street, New York, NY 10018'], // array
      // input: '40.7863301, -73.95027060000001', // coordinates for reverseGeocode => set reverseGeocode = true;
      input: [{'address1':'1501 Lexington Avenue, New York, NY 10029', 'address2':'Columbus Circle, New York, NY'}, {'address1':'54 West 40th Street, New York, NY 10018', 'address2':'Brooklyn Bridge Park, New York, NY'}], // array of objects
      // input: {'address': '1501 Lexington Avenue, New York, NY 10029' }, // object
      output: [],
      /**
       * 'reverseGeocode' is set to true when input is a set of lat/lng coordinates that need to be converted to a location
       * @type {Boolean}
       */
      reverseGeocode: false,
      apiReady: function(){
        var self = this;
        self.geocoder = new google.maps.Geocoder(); 
        self.geocodeFunc = self.reverseGeocode ? self._addLocationToOutput : self._addGeocodeToOutput;
        if(self.input){
          self.inputChanged();
        }
      },
      inputChanged: function(){
        var self = this;
        console.log("input changed");
        // Clear output anytime the input changes
        self.output= []; 

        if (self.geocoder){
          // Determine data structure of input and get coordinates for each location
          switch (typeof(self.input)){
            // Input is a string
            case "string":
              self.inputLength=1;
              self.geocodeFunc(self.input, self.output);
              break;
            
            // Input is an array or object
            case "object": 
              var length = self.input.length;
              if (length > 0){
                for (var i=0; i<length; i++){
                  self.inputLength=self.input.length;
                  // Array of strings
                  if (typeof(self.input[i]) === 'string'){ 
                    self.geocodeFunc(self.input[i], self.output);
                  }
                  // Array of objects
                  else if (typeof(self.input[i]) === 'object'){ 
                    self._dataAttributes = Object.keys(self.input[i]);
                    self._selectedLabel = self._selectedLabel || self._dataAttributes[0];
                    self.geocodeFunc(self.input[i][self._selectedLabel], self.output);
                  // Array of anything else 
                  } else { 
                    alert("Invalid input data");      
                  }
                }

              // Single object              
              } else { 
                self.inputLength=1;
                self._dataAttributes = Object.keys(self.input);
                self._selectedLabel = self._selectedLabel || self._dataAttributes[0];
                self.geocodeFunc(self.input[self._selectedLabel], self.output);
              }
              break;  

            // Input is something else
            default: 
              alert("Invalid input data");      
          }
        }

      },
      /**
       * '_addGeocodeToOutput' adds an object containing the location and coordinates to the output array
       * @param {string} input - representing a valid location or address
       * @param {array} outputArr - the array to which geolocation object should be added to
       */
      _addGeocodeToOutput: function(location, outputArr){
        var self = this;
        self.geocoder.geocode({'address': location}, function(results, status){
           if (status == google.maps.GeocoderStatus.OK) {

              var lat = results[0].geometry.location.k,
                  lng = results[0].geometry.location.B;
                  console.log(lat);
              outputArr.push({'input': location, 'label': location, 'latitude': lat, 'longitude':lng});
              console.log(self.output);
           } else {
              alert("Geocode was not successful for the following reason: " + status);
           }

        });
      },
      /**
       * '_addLocationToOutput' adds an object containing the location and coordinates to the output array
       * @param {string} latlng - lat and long coordinates separated by comma
       * @param {[type]} outputArr - the array to which geolocation object should be added to
       */
      // TODO: allow for latlng to be given in different ways, or separately
      _addLocationToOutput: function(latlng, outputArr){
        var self = this;
        
        var latlngStr = latlng.split(',',2),
            lat = parseFloat(latlngStr[0]),
            lng = parseFloat(latlngStr[1]),
            coordinates = new google.maps.LatLng( lat, lng );
        
        self.geocoder.geocode({'latLng': coordinates}, function(results, status){
           if (status == google.maps.GeocoderStatus.OK) {
              // TODO: what should the output look like?? can also get city, state, zip, etc separately 
              var location = results[0].formatted_address;
              outputArr.push({'input': latlng, 'label': location, 'latitude':lat, 'longitude': lng });
              console.log(outputArr);
           } else {
              alert("Geocode was not successful for the following reason: " + status);
           }
        });
      },
      /**
       * _selectedLabelChanged calls the inputChanged method when the selection changes
       * @return {[type]} [description]
       */
      _selectedLabelChanged: function(){
        this.inputChanged();
      },
      /**
       * showControls toggles the menu for choosing the correct field
       */
      showControls: function(e) {
        this.$.ctrl_collapse.toggle();
      },
      outputChanged: function(){
        var self = this;
        // When output is ready, fire event for other components to use
        if (self.output.length === self.inputLength){
          self.fire('th-output-ready', self.output)
        }
      }
     

    });

  </script>

</polymer-element>
